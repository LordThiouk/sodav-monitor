---
description: RÃ¨gle de DÃ©tection AvancÃ©e pour l'Algorithme SODAV Monitor
globs: *
---
#### ğŸ§ **1. Identification du Type de Contenu**
- Analyser le flux audio pour dÃ©terminer si le contenu est :
  - ğŸ¶ **Musique** : Continuer le processus de dÃ©tection, utilise /api/channels/detect-music pour la detection.
  - ğŸ™ï¸ **Speech** : Ignorer la dÃ©tection, enregistrer seulement les mÃ©tadonnÃ©es de la diffusion.

--- Ne confond pas ACOUSTID_API_KEY et AUDD_API_KEY c'est deux services distincts, pour la detection assure toi que les deux soient fournis

#### ğŸ¼ **2. Processus de DÃ©tection HiÃ©rarchique**
Si le contenu est identifiÃ© comme **musique**, suivre cet ordre de dÃ©tection :

1. ğŸ” **DÃ©tection Locale**  
   - Rechercher des correspondances dans la base de donnÃ©es locale Ã  l'aide des empreintes digitales enregistrÃ©es.  
   - Si une correspondance est trouvÃ©e, procÃ©der Ã  l'enregistrement des donnÃ©es.

2. ğŸŒ **DÃ©tection avec MusicBrainz**  
   - Si la dÃ©tection locale Ã©choue, interroger l'API MusicBrainz pour tenter une identification externe.  
   - Si trouvÃ©e, enregistrer les mÃ©tadonnÃ©es rÃ©cupÃ©rÃ©es.

3. ğŸ§ **DÃ©tection avec Audd**  
   - Si MusicBrainz Ã©choue Ã©galement, utiliser l'API Audd comme solution de dernier recours.  
   - Enregistrer les informations fournies par Audd.

---

#### ğŸ“¥ **3. Enregistrement des DonnÃ©es Ã  Chaque DÃ©tection**
Pour chaque dÃ©tection rÃ©ussie (quelle que soit la mÃ©thode), enregistrer automatiquement :

- ğŸ”‘ **Empreinte Digitale** :
  - `fingerprint` : Empreinte audio analysÃ©e.
  - `fingerprint_raw` : DonnÃ©es brutes de l'empreinte audio.

- â±ï¸ **Temps de Jeu Exact** :
  - DurÃ©e exacte pendant laquelle la musique a Ã©tÃ© diffusÃ©e, par station.

- ğŸ¯ **Confiance de DÃ©tection** :
  - Enregistrer le score de confiance (`confidence`) donnÃ© par l'algorithme ou l'API.

---

#### âŒ **4. Gestion des DÃ©tections Non IdentifiÃ©es**
Si aucune correspondance n'est trouvÃ©e aprÃ¨s toutes les tentatives :

- ğŸ“ **Journalisation des Tentatives** :
  - Consigner la tentative de dÃ©tection Ã©chouÃ©e dans les logs avec le timestamp, l'empreinte et la station.

- ğŸ”„ **RÃ©essai de DÃ©tection Locale** :
  - RÃ©essayer la dÃ©tection locale Ã  l'aide des empreintes enregistrÃ©es prÃ©cÃ©demment.

---

#### ğŸ”„ **5. Mise Ã  Jour des DonnÃ©es**
Ã€ chaque dÃ©tection (rÃ©ussie ou non), mettre Ã  jour les tables suivantes :

- ğŸ¼ **Tracks** :
  - Nombre de dÃ©tections
  - Temps de jeu total
  - DerniÃ¨re date de dÃ©tection

- ğŸ“Š **TrackStats**, **ArtistStats**, **StationStats** :
  - Nombre de dÃ©tections
  - Temps de jeu cumulÃ©
  - Confiance moyenne
  - DerniÃ¨re dÃ©tection

- ğŸ“» **StationTrackStats** :
  - Temps de jeu par station
  - DerniÃ¨re diffusion enregistrÃ©e

- ğŸ“ˆ **AnalyticsData** :
  - Statistiques en temps rÃ©el sur les dÃ©tections, la confiance moyenne et le nombre de stations actives.
