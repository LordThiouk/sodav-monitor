---
description: Pour tester le play duration tu dois reproduire tous le cycle detection en utilisant tous les composants nÃ©cÃ©ssaire, pas de simulations ou de mocks, on doit connaitre le temps de jeu Ã©xacte des sons sur les stations.
globs: *
---
Pour tester le play duration tu dois reproduire tous le cycle detection en utilisant tous les composants nÃ©cÃ©ssaire, pas de simulations ou de mocks, on doit connaitre le temps de jeu Ã©xacte des sons sur les stations.

Lâ€™objectif est dâ€™avoir une mesure **prÃ©cise et fiable** de la durÃ©e de diffusion de chaque musique dÃ©tectÃ©e sur une station de radio.

---

### **ğŸ“Œ 1. DÃ©tection et Suivi en Temps RÃ©el**
âœ… **DÃ©marrer un timer** lorsqu'un son est dÃ©tectÃ©.
âœ… **VÃ©rifier en continu** si le mÃªme son est toujours jouÃ©.
âœ… **ArrÃªter le timer** lorsque le son change ou que le silence est dÃ©tectÃ©.
âœ… **Enregistrer la durÃ©e de lecture exacte** dans `play_duration`.

---

### **ğŸ“Œ 2. Priorisation des DÃ©tections**
L'algorithme suit ces Ã©tapes pour chaque son dÃ©tectÃ© :
1ï¸âƒ£ **DÃ©tection locale** â†’ VÃ©rifier si le son est dÃ©jÃ  enregistrÃ© avec son empreinte (`fingerprint`).
2ï¸âƒ£ **DÃ©tection via MusicBrainz** â†’ Si Ã©chec local, interroger la base externe.
3ï¸âƒ£ **DÃ©tection via Audd.io** â†’ Dernier recours pour identifier la musique.

---

### **ğŸ“Œ 3. Conditions de Fin dâ€™un Son**
Un son est considÃ©rÃ© comme **terminÃ©** lorsque :
âœ” **Un autre son est dÃ©tectÃ©** (nouvelle empreinte `fingerprint`).
âœ” **Un silence est dÃ©tectÃ©** (ex. absence dâ€™audio sur 2-3 sec).
âœ” **Le flux change** (ex. changement de programme radio).

---

### **ğŸ“Œ 4. DonnÃ©es EnregistrÃ©es pour Chaque DÃ©tection**
Ã€ chaque dÃ©tection, les informations suivantes doivent Ãªtre **mises Ã  jour** :
âœ” `track_id` â†’ Identifiant unique de la musique.
âœ” `station_id` â†’ Identifiant de la station de radio.
âœ” `confidence` â†’ Niveau de confiance de la dÃ©tection.
âœ” `detected_at` â†’ Timestamp de dÃ©but.
âœ” `play_duration` â†’ DurÃ©e exacte du son jouÃ©.
âœ” `fingerprint` & `fingerprint_raw` â†’ Empreinte acoustique pour future comparaison.

---

### **ğŸ“Œ 5. Mise Ã  Jour Automatique des Statistiques**
Chaque nouvelle dÃ©tection doit :
ğŸ”„ **Mettre Ã  jour `TrackStats`** â†’ Nombre de lectures, durÃ©e totale, derniÃ¨re dÃ©tection.
ğŸ”„ **Mettre Ã  jour `StationStats`** â†’ Temps total de musique jouÃ© par station.
ğŸ”„ **Mettre Ã  jour `ArtistStats`** â†’ DurÃ©e cumulÃ©e par artiste.

---

### **ğŸ“Œ 6. Gestion des Cas Particuliers**
âš  **Si une coupure de flux est dÃ©tectÃ©e** â†’ Enregistrer lâ€™arrÃªt du son et ignorer la coupure.
âš  **Si un son redÃ©marre aprÃ¨s une pause courte** â†’ Fusionner les lectures si elles sont Ã  moins de **5 secondes** dâ€™intervalle.
âš  **Si un son non identifiÃ© est jouÃ© plusieurs fois** â†’ Sauvegarder lâ€™empreinte pour une future reconnaissance.

---

### **ğŸš€ Application des RÃ¨gles**
âœ” **ImplÃ©menter ces rÃ¨gles dans `TrackDetection` et `TrackStats`.**
âœ” **IntÃ©grer un test automatisÃ© pour vÃ©rifier que `play_duration` est exact.**
âœ” **Synchroniser avec Cursor AI pour assurer leur application.**
 4. Tests de RÃ©silience et Performance
âœ… Tester la robustesse de la dÃ©tection en simulant :

Changements de flux radio (ex: passage dâ€™un son Ã  un autre)
DÃ©tections multiples simultanÃ©es
Temps de rÃ©ponse de lâ€™algorithme
âœ… VÃ©rifier que le systÃ¨me ne crÃ©e pas de doublons en cas de dÃ©tection rapprochÃ©e du mÃªme son.

---

ğŸ¯ **Objectif Final** : Avoir des **donnÃ©es prÃ©cises et exploitables** pour lâ€™analyse du temps de diffusion des musiques sur chaque station en Ã©vitant les erreurs et doublons. ğŸš€
