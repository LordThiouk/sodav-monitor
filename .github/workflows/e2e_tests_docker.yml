name: End-to-End Tests in Docker

on:
  workflow_dispatch:  # Permet de déclencher manuellement le workflow
  schedule:
    - cron: '0 0 * * 1'  # Exécute chaque lundi à minuit

jobs:
  e2e_tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build and start Docker containers
      run: |
        docker compose -f docker-compose.yml up -d
      env:
        ACOUSTID_API_KEY: ${{ secrets.ACOUSTID_API_KEY }}
        AUDD_API_KEY: ${{ secrets.AUDD_API_KEY }}
    
    - name: Wait for containers to be ready
      run: |
        echo "Waiting for containers to be ready..."
        sleep 30
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio pytest-html httpx PyJWT python-jose pydantic==1.10.8 pydantic-settings==1.2.2 python-multipart email-validator aiohttp pandas
    
    - name: Install required packages for tests
      run: |
        # Installer les dépendances par petits groupes pour éviter les problèmes de mémoire
        echo "Installation des dépendances de base..."
        docker exec sodav-backend pip install --no-cache-dir pytest pytest-asyncio pytest-html
        
        echo "Installation des dépendances HTTP..."
        docker exec sodav-backend pip install --no-cache-dir httpx aiohttp
        
        echo "Installation des dépendances d'authentification..."
        docker exec sodav-backend pip install --no-cache-dir PyJWT python-jose
        
        echo "Installation des dépendances de validation..."
        # Installer des versions spécifiques de pydantic et pydantic-settings pour éviter les problèmes de compatibilité
        docker exec sodav-backend pip install --no-cache-dir pydantic==1.10.8 pydantic-settings==1.2.2 python-multipart email-validator
        
        echo "Installation des dépendances de base de données..."
        docker exec sodav-backend pip install --no-cache-dir sqlalchemy psycopg2-binary redis
        
        echo "Installation des dépendances FastAPI..."
        docker exec sodav-backend pip install --no-cache-dir fastapi==0.95.2 uvicorn aiofiles
        
        echo "Installation des dépendances d'analyse de données..."
        docker exec sodav-backend pip install --no-cache-dir pandas numpy
        
        echo "Installation des dépendances de test spécifiques..."
        docker exec sodav-backend pip install --no-cache-dir coverage==7.2.7 pytest-cov==4.1.0 pytest-mock
        
        # Créer le répertoire pour les résultats de test
        docker exec sodav-backend mkdir -p /app/test_results
    
    - name: Run detection workflow test
      run: |
        docker exec sodav-backend bash -c "cd /app && python -m pytest backend/tests/integration/test_end_to_end.py::TestEndToEnd::test_detection_workflow -v --log-cli-level=INFO --html=/app/test_results/detection_workflow_report.html"
      continue-on-error: true
    
    - name: Run report generation test
      run: |
        docker exec sodav-backend bash -c "cd /app && python -m pytest backend/tests/integration/test_end_to_end.py::TestEndToEnd::test_report_generation -v --log-cli-level=INFO --html=/app/test_results/report_generation_report.html"
      continue-on-error: true
    
    - name: Run play duration accuracy test
      run: |
        docker exec sodav-backend bash -c "cd /app && python -m pytest backend/tests/integration/test_end_to_end.py::TestEndToEnd::test_play_duration_accuracy -v --log-cli-level=INFO --html=/app/test_results/play_duration_report.html"
      continue-on-error: true
    
    - name: Run end-to-end workflow test
      run: |
        docker exec sodav-backend bash -c "cd /app && python -m pytest backend/tests/integration/test_end_to_end.py::TestEndToEnd::test_end_to_end_workflow -v --log-cli-level=INFO --html=/app/test_results/end_to_end_workflow_report.html"
      continue-on-error: true
    
    - name: Create test results directory
      run: mkdir -p test_results
    
    - name: Copy test results from container
      run: |
        docker cp sodav-backend:/app/test_results/. ./test_results/
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-reports
        path: test_results/
    
    - name: Stop Docker containers
      run: docker compose down 